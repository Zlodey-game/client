<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>map</title>

    
</head>
<link rel="stylesheet" href="game.css">
<script src="src/ui.js"></script>
<!-- <body onload="draw();"> -->
<body style="margin: 0;">
    <canvas id="canvas">
    </canvas>
</body>
<script type="application/javascript">
    var canvas;
    var canvasCtx;

    var canvasBuffer;
    var bufferCtx;

    var canvasOldWidth;
    var canvasOldHeight;

    var monsters = [];

    var playerUnit = {}; //Player Unit Property
    var pointer = {};
    var inventory = [];

    var droppedItems = [];

    
    var ghostUnit = {}; //Player Unit Property

    var threadSpeed = 10;     //Gap of Thread
    var keyPressOn = {};//pressed - trueaaaaaa

    var character;
    var asphalt;
    var items = [];

    var gameLoopThread;  //animation Thread ID


    let mainBox = {};
    let mainBar = {};
    let inven = {};
    let statBox = {};
    let statBar = {};
    let LVupBox = {};
    let invenBox = {};

    window.onload = function(e) {
        canvas = document.getElementById('canvas'); 
        canvasBuffer = document.createElement("canvas");       
        setCanvasSize();
    }
    
    window.onresize = function(e) {
        setCanvasSize();
    }
    
    function setCanvasSize() {
        const browserWidth = window.innerWidth;
        const browserHeight = window.innerHeight-4;

        if(browserWidth / browserHeight < 1.777) { //  width small
            canvas.width = browserWidth;
            canvas.height = browserWidth * 0.5625;
        }
        else{
            canvas.width = browserHeight * 1.777;
            canvas.height = browserHeight;
        }
        
        canvasBuffer.width = canvas.width;
        canvasBuffer.height = canvas.height;

        setUIBoxes();

        setUnitSize(playerUnit, 0.06, 0.106, 2.5);
        setUnitSize(ghostUnit, 0.093, 0.166, 2.5);

        canvasOldWidth = canvas.width;
        canvasOldHeight = canvas.height;
    }

    function setUnitSize(unit, wd, hd, speed){
        unit.width = canvas.width*wd;
        unit.height = canvas.height*hd;
            //width: 120,
            //height: 160,
        unit.oX_speed = canvas.width*0.0008*speed;
        unit.oY_speed = canvas.height*0.0014*speed;

        if(unit.x == undefined){
            unit.x = canvas.width / 2 - unit.width / 2;
            unit.y = canvas.height / 2 - unit.height / 2;
        }
        else{
            unit.x = unit.x * (canvas.width / canvasOldWidth);
            unit.y = unit.y * (canvas.height / canvasOldHeight);
        }
    }

    function setUnitAngle(unit, x, y){
        unit.agl = Math.atan2(x - (unit.x + unit.width/2) , (unit.y + unit.height/2) - y) * 180 / Math.PI;
    }

    function setPlayerStatus(unit, mode){
        if(mode == 'speed'){
            unit.X_speed = unit.oX_speed + unit.oX_speed * (unit.agi * 0.01);
            unit.Y_speed = unit.oY_speed + unit.oY_speed * (unit.agi * 0.01);
        }
    }

    window.addEventListener("load", init, false);

    document.addEventListener("mousemove", (e) => {
        pointer.x = e.clientX;
        pointer.y = e.clientY;
        
        setUnitAngle(playerUnit, pointer.x, pointer.y);
    }, false);

    document.addEventListener("click", (e)=>{
        if(getMouseWhich(e.clientX, e.clientY) == 'game') attack();
    }, false);

    document.addEventListener("mousedown", (e)=>{
        which = getMouseWhich(e.clientX, e.clientY);
        if(which != 'game') moveInven(which, e.clientX, e.clientY, 'down');
    }, false);

    document.addEventListener("mouseup", (e)=>{
        which = getMouseWhich(e.clientX, e.clientY);
        if(which != 'game') moveInven(which, e.clientX, e.clientY, 'up');
    }, false);

    function getMouseWhich(x, y){
        const mArea = {
            dx : (canvas.width - mainBox.width)/2,
            ux : (canvas.width - mainBox.width)/2 + mainBox.width,
            dy : canvas.height - mainBox.height,
            uy : canvas.height
        };
        const iArea = {
            dx : canvas.width - invenBox.width,
            ux : canvas.width,
            dy : canvas.height - invenBox.height,
            uy : canvas.height
        };

        if(mArea.dx <= x && mArea.ux >= x && mArea.dy <= y && mArea.uy >= y){
            return 'inven';
        }
        else if(iArea.dx <= x && iArea.ux >= x && iArea.dy <= y && iArea.uy >= y){
            return 'slot';
        }
        else{
            return 'game';
        }
    }
    
    function init(){
        //canvas = document.getElementById("canvas");
        canvasCtx = canvas.getContext("2d");

        bufferCtx = canvasBuffer.getContext("2d");

        playerUnit.x = canvas.width / 2 - 18;
        playerUnit.y = canvas.height / 2 - 18;
        playerUnit.agl = 0;

        playerUnit.atk = 30;
        playerUnit.def = 500;
        playerUnit.maxHp = 100;
        playerUnit.agi = 0;
        playerUnit.lv = 1;
        playerUnit.exp = 100;

        playerUnit.hp = 50;
        playerUnit.mp = 0;

        pointer.x = playerUnit.x;
        pointer.y = playerUnit.y;

        ghostUnit.x = canvas.width / 2 - 18;
        ghostUnit.y = canvas.height / 2 - 18;
        ghostUnit.maxHp = 100;
        ghostUnit.hp = 100;

        document.addEventListener("keydown", getKeyDown, false);
        document.addEventListener("keyup", getKeyUp, false);

        setImage();

        gameLoopThread = setInterval(gameLoop, threadSpeed);

        monsters.push(ghostUnit);

        for(let i=0; i<13; i++){
            inventory[i] = {};
            inventory[i].id = undefined;
            inventory[i].clicked = false;
        }
    }

    function setImage(){
        character = new Image();
        character.src = "char.png";

        ghost = new Image();
        ghost.src = "ghost.png";

        asphalt = new Image();
        asphalt.src = "asphalt.jpg";

        for(let i=2; i<14; i++){
            items[i] = new Image();
            items[i].src = `itemImg/${i}.png`;
        }
        //console.log(ghost);
    }

    function getKeyDown(event){
        var keyValue;
        if(event == null) return;
        else {
            keyValue=event.keyCode;
            event.preventDefault();
        }
        if(keyValue == "87") keyValue = "38";       //up
        else if(keyValue == "83") keyValue = "40";  //down
        else if(keyValue == "65") keyValue = "37";  //left
        else if(keyValue == "68") keyValue = "39";  //right
        keyPressOn[keyValue] = true;
    }

    function getKeyUp(event){
        var keyValue;
        if(event == null){
            keyValue = window.event.keyCode;
            window.event.preventDefault();
        }
        else{
            keyValue=event.keyCode;
            event.preventDefault();
        }
        if(keyValue == "87") keyValue = "38";       //up
        else if(keyValue == "83") keyValue = "40";  //down
        else if(keyValue == "65") keyValue = "37";  //left
        else if(keyValue == "68") keyValue = "39";  //right
        
        keyPressOn[keyValue] = false;
    }

    function gameLoop(){  
        calcKeyInput();
        displayAll();
    }

    function calcKeyInput(){
        let agl = null;
        let changed = false;
        //console.log(keyPressOn);
        if(keyPressOn["38"] && playerUnit.y >= 0){
            playerUnit.y -= playerUnit.Y_speed;  //up
        }
        if(keyPressOn["40"] && playerUnit.y <= canvas.height -playerUnit.height){
            
            playerUnit.y += playerUnit.Y_speed;  //down
        }
        if(keyPressOn["37"] && playerUnit.x >= 0){
            playerUnit.x -= playerUnit.X_speed;  //left
        }
        if(keyPressOn["39"] && playerUnit.x <= canvas.width - playerUnit.width){
            playerUnit.x += playerUnit.X_speed;  //right
        }
        
        for(let i = 0; i<droppedItems.length; i++){
            //console.log(droppedItems);
            checkGetItem(playerUnit, droppedItems[i], i);
        }
           
        setUnitAngle(playerUnit, pointer.x, pointer.y);
        //if(agl != null) playerUnit.agl = agl;
    }

    function displayAll(){
        drawRoad();
        
        bufferCtx.beginPath();
        var startAngle = 0; 

        drawDroppedItems();

        for(unit of monsters){
            drawUnit(unit, ghost);
            drawMonsterHPBar('#050D0B', '#BC252A', '#726447', unit);
        }

        setPlayerStatus(playerUnit, 'speed');
        drawUnit(playerUnit);

        drawMainUI();
        
        canvasCtx.drawImage(canvasBuffer, 0, 0);
    }

    function attack(){
        var p  = playerUnit;
        var allowDeg = 15;

        //console.log('clicked');
        //monsters.pop()
        //console.log(monsters);
        for(let i=0; i<monsters.length; i++){
            var unit = monsters[i];

            var agl = Math.atan2((unit.x + unit.width/2) - (p.x + p.width/2), (p.y + p.height/2) - (unit.y + unit.height/2)) * 180 / Math.PI;
            var len = Math.hypot((p.y + p.height/2) - (unit.y + unit.height/2), (unit.x + unit.width/2) - (p.x + p.width/2));


            if(p.agl - allowDeg < agl && p.agl + allowDeg > agl && len < p.width * 2.0){
                //console.log('Attaked!');                 
                unit.hp -= p.atk;
                if(unit.hp <= 0){
                    //console.log('Dead!');                 
                    if (i > -1) monsters.splice(i, 1)
                    playerUnit.exp += 2;
                    dropItem(unit.x, unit.y);
                }
            }
        }
    }

    function moveInven(which, x, y, flg){
        console.log(which);
        if(flg == 'down'){
            for(let i=0; i<13; i++){
                inventory[i].clicked = false;
            }
            if(which == 'inven'){
                let idx;
                const box = {
                    dy : canvas.height - mainBox.height + mainBox.height * 0.47 - inven.len,
                    uy : canvas.height - mainBox.height + mainBox.height * 0.47
                }
                console.log(y, box.dy, box.uy);
                if(box.dy <= y && box.uy >= y){
                    const base = (canvas.width - mainBox.width) / 2 + (mainBox.width - inven.len)/2;
                    for(idx=0; idx<9; idx++){
                        box.dx = base + (inven.len*1.2 + inven.lineWidth) * (idx-4);
                        box.ux = base + (inven.len*1.2 + inven.lineWidth) * (idx-4) + inven.len;
                        //console.log(x, box.dx, box.ux);
                        if(box.dx < x && box.ux > x){
                            console.log(idx);
                            break;
                        }
                    }
                    
                    inventory[idx].clicked = true;                
                } 
            }
        }
        else if(flg == 'up'){
            
            if(which == 'inven'){
                let idx;
                const box = {
                    dy : canvas.height - mainBox.height + mainBox.height * 0.47 - inven.len,
                    uy : canvas.height - mainBox.height + mainBox.height * 0.47
                }
                console.log(y, box.dy, box.uy);
                if(box.dy <= y && box.uy >= y){
                    const base = (canvas.width - mainBox.width) / 2 + (mainBox.width - inven.len)/2;
                    for(idx=0; idx<9; idx++){
                        box.dx = base + (inven.len*1.2 + inven.lineWidth) * (idx-4);
                        box.ux = base + (inven.len*1.2 + inven.lineWidth) * (idx-4) + inven.len;
                        //console.log(x, box.dx, box.ux);
                        if(box.dx < x && box.ux > x){
                            console.log(idx);
                            break;
                        }
                    }
                    
                    var origin = inventory.findIndex(obj=>obj.clicked==true);

                    var temp = inventory[origin];
                    
                    inventory[origin] = inventory[idx];
                    inventory[idx] = temp;
                    console.log(inventory[idx], inventory[origin]);
                    inventory[idx].clicked = false;
                } 
            }
            // for(let i=0; i<13; i++){
            //     inventory[i].clicked = undefined;
                    
            // }
        }
    }

    function dropItem(x, y){
        let min = Math.ceil(2);
        let max = Math.floor(14);
        
        var itemNum = Math.floor(Math.random() * (max - min)) + min; //최댓값은 제외, 최솟값은 포함

        //console.log(x, y, itemNum);
        var item = {
            itemId : itemNum,
            x : x,
            y : y,
            len : canvas.width * 0.07
        }
        droppedItems.push(item);
    }

    function drawDroppedItems(){
        //console.log(droppedItems);
        for(item of droppedItems){
            bufferCtx.drawImage(items[item.itemId], //Source Image
                item.x, item.y, //View Position
                item.len, item.len //View Size
            );
        }
    }

    function checkGetItem(unit, item, idx){
        if(unit.x < item.x + item.len * 0.5 && unit.x + unit.width > item.x + item.len * 0.5 && 
           unit.y < item.y + item.len * 0.5 && unit.y + unit.height > item.y + item.len * 0.5){
            var emptyIdx = inventory.findIndex(obj=>obj.id == undefined);
            if(emptyIdx < 9){
                inventory[emptyIdx].id = item.itemId;
            }
            
            droppedItems.splice(idx, 1);
        }
    }

    function drawMainUI(){
        
        let list = [
            {
                name: 'ATK',
                value: playerUnit.atk,
                color: '#EB5335'
            },
            {
                name: 'DEF',
                value: playerUnit.def,
                color: '#8C8C8C'
            },
            {
                name: 'H P',
                value: playerUnit.maxHp,
                color: '#70AD47'
            },
            {
                name: 'AGI',
                value: playerUnit.agi,
                color: '#FFB801'
            },
            {
                name: 'L V',
                value: playerUnit.lv,
                color: '#CDD121'
            },
            {
                name: 'EXP',
                value: playerUnit.exp,
                color: '#CDD121'
            }
        ];

        drawMainBox('#102020', '#726447', mainBox);
        
        drawMainBar('#050D0B', '#00B801', '#726447', mainBar, mainBox, 0.7, playerUnit.hp / playerUnit.maxHp * 100);
        drawMainBar('#050D0B', '#2183F3', '#726447', mainBar, mainBox, 0.9, playerUnit.mp);

        for(let i=0; i<9; i++){
            drawInven('#151D1B','#726447', inven, mainBox, i);    
        }

        drawStatBox('#102020', '#726447', statBox);
        
        for(let i=0; i<6; i++){
            drawStat(list[i].name,  list[i].value, list[i].color , statBar, statBox, i);
        }

        drawLVup('#102020', '#726447', LVupBox, statBox, 3);

        drawInvenBox('#102020', '#726447', invenBox);

        for(let i=0; i<4; i++){
            drawEquipment('#151D1B','#726447', inven, invenBox, i, null);
        }

        for(let i=0; i<9; i++){
            drawInvenItem('#151D1B','#726447', inven, mainBox, i, inventory[i]);    
        }
    }

    
</script>
</html>