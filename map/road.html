<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>map</title>

    
</head>
<link rel="stylesheet" href="game.css">
<script src="src/ui.js"></script>
<script src="src/input.js"></script>
<script src="src/unit.js"></script>
<script src="src/window.js"></script>

<!-- <body onload="draw();"> -->
<body style="margin: 0;">
    <canvas id="canvas">
    </canvas>
</body>
<script type="application/javascript">
    var canvas;
    var canvasCtx;

    var canvasBuffer;
    var bufferCtx;

    var canvasOldWidth;
    var canvasOldHeight;

    var monsters = [];

    var playerUnit = {}; //Player Unit Property
    var pointer = {};
    var inventory = [];

    var droppedItems = [];

    var monsterRegenSpeed = 10 * 1000;     //Gap of Thread
    var ghostUnit = {}; //Player Unit Property

    var threadSpeed = 10;     //Gap of Thread
    var keyPressOn = {};//pressed - trueaaaaaa

    var character;
    var asphalt;
    var items = [];

    var gameLoopThread;  //animation Thread ID

    let mainBox = {};
    let mainBar = {};
    let inven = {};
    let statBox = {};
    let statBar = {};
    let LVupBox = {};
    let invenBox = {};

    window.addEventListener("load", init, false);

    function getMouseWhich(x, y){
        const mArea = {
            dx : (canvas.width - mainBox.width)/2,
            ux : (canvas.width - mainBox.width)/2 + mainBox.width,
            dy : canvas.height - mainBox.height,
            uy : canvas.height
        };
        const iArea = {
            dx : canvas.width - invenBox.width,
            ux : canvas.width,
            dy : canvas.height - invenBox.height,
            uy : canvas.height
        };

        if(mArea.dx <= x && mArea.ux >= x && mArea.dy <= y && mArea.uy >= y){
            return 'inven';
        }
        else if(iArea.dx <= x && iArea.ux >= x && iArea.dy <= y && iArea.uy >= y){
            return 'slot';
        }
        else{
            return 'game';
        }
    }
    
    function init(){
        //canvas = document.getElementById("canvas");
        canvasCtx = canvas.getContext("2d");

        bufferCtx = canvasBuffer.getContext("2d");

        playerUnit.x = canvas.width / 2 - 18;
        playerUnit.y = canvas.height / 2 - 18;
        playerUnit.agl = 0;

        playerUnit.atk = 30;
        playerUnit.def = 500;
        playerUnit.maxHp = 100;
        playerUnit.agi = 0;
        playerUnit.lv = 1;
        playerUnit.exp = 100;

        playerUnit.hp = 50;
        playerUnit.mp = 0;

        pointer.x = playerUnit.x;
        pointer.y = playerUnit.y;

        ghostUnit.x = canvas.width / 2 - 18;
        ghostUnit.y = canvas.height / 2 - 18;
        ghostUnit.maxHp = 100;
        ghostUnit.hp = 100;

        document.addEventListener("keydown", getKeyDown, false);
        document.addEventListener("keyup", getKeyUp, false);

        setImage();

        gameLoopThread = setInterval(gameLoop, threadSpeed);

        monsterRegenThread = setInterval(genMonster, monsterRegenSpeed);

        monsters.push(ghostUnit);

        for(let i=0; i<13; i++){
            inventory[i] = {};
            inventory[i].id = undefined;
            inventory[i].clicked = false;
        }
    }

    function gameLoop(){  
        calcKeyInput();
        displayAll();
    }

    function calcKeyInput(){
        let agl = null;
        let changed = false;
        //console.log(keyPressOn);
        if(keyPressOn["38"] && playerUnit.y >= 0){
            playerUnit.y -= playerUnit.Y_speed;  //up
        }
        if(keyPressOn["40"] && playerUnit.y <= canvas.height -playerUnit.height){
            
            playerUnit.y += playerUnit.Y_speed;  //down
        }
        if(keyPressOn["37"] && playerUnit.x >= 0){
            playerUnit.x -= playerUnit.X_speed;  //left
        }
        if(keyPressOn["39"] && playerUnit.x <= canvas.width - playerUnit.width){
            playerUnit.x += playerUnit.X_speed;  //right
        }
        
        for(let i = 0; i<droppedItems.length; i++){
            //console.log(droppedItems);
            checkGetItem(playerUnit, droppedItems[i], i);
        }
           
        setUnitAngle(playerUnit, pointer.x, pointer.y);
        //if(agl != null) playerUnit.agl = agl;
    }

    function displayAll(){
        drawRoad();
        
        bufferCtx.beginPath();
        var startAngle = 0; 

        drawDroppedItems();

        for(unit of monsters){
            drawUnit(unit, ghost);
            drawMonsterHPBar('#050D0B', '#BC252A', '#726447', unit);
        }

        setPlayerStatus(playerUnit, 'speed');
        drawUnit(playerUnit);

        drawMainUI();
        
        canvasCtx.drawImage(canvasBuffer, 0, 0);
    }

    function drawMainUI(){
        let list = [
            {
                name: 'ATK',
                value: playerUnit.atk,
                color: '#EB5335'
            },
            {
                name: 'DEF',
                value: playerUnit.def,
                color: '#8C8C8C'
            },
            {
                name: 'H P',
                value: playerUnit.maxHp,
                color: '#70AD47'
            },
            {
                name: 'AGI',
                value: playerUnit.agi,
                color: '#FFB801'
            },
            {
                name: 'L V',
                value: playerUnit.lv,
                color: '#CDD121'
            },
            {
                name: 'EXP',
                value: playerUnit.exp,
                color: '#CDD121'
            }
        ];

        drawMainBox('#102020', '#726447', mainBox);
        
        drawMainBar('#050D0B', '#00B801', '#726447', mainBar, mainBox, 0.7, playerUnit.hp / playerUnit.maxHp * 100);
        drawMainBar('#050D0B', '#2183F3', '#726447', mainBar, mainBox, 0.9, playerUnit.mp);

        for(let i=0; i<9; i++){
            drawInven('#151D1B','#726447', inven, mainBox, i);    
        }

        drawStatBox('#102020', '#726447', statBox);
        
        for(let i=0; i<6; i++){
            drawStat(list[i].name,  list[i].value, list[i].color , statBar, statBox, i);
        }

        drawLVup('#102020', '#726447', LVupBox, statBox, 3);

        drawInvenBox('#102020', '#726447', invenBox);

        for(let i=0; i<4; i++){
            drawEquipment('#151D1B','#726447', inven, invenBox, i, null);
        }

        for(let i=0; i<14; i++){
            drawInvenItem(inven, mainBox, inven, invenBox, i, inventory[i]);    
        }
    }

    
</script>
</html>