<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>map</title>

    
</head>
<link rel="stylesheet" href="game.css">
<script src="src/ui.js"></script>
<script src="src/input.js"></script>
<script src="src/unit.js"></script>
<script src="src/window.js"></script>

<!-- <body onload="draw();"> -->
<body style="margin: 0;">
    <canvas id="canvas">
    </canvas>
</body>
<script type="application/javascript">
    let canvas;
    let canvasCtx;

    let canvasBuffer;
    let bufferCtx;

    let canvasOldWidth;
    let canvasOldHeight;

    let monsters = [];

    let playerUnit = {}; //Player Unit Property
    let pointer = {};
    let inventory = [];

    let droppedItems = [];

    const monsterRegenSpeed = 10 * 1000;     //Gap of Thread

    const threadSpeed = 12;     //Gap of Thread
    let keyPressOn = {};//pressed - trueaaaaaa

    let isPause = false;
    let isPush = false;
    let oldPush = 0;

    let character;
    let asphalt;
    let items = [];
    let itemInfo = [
        {
            type : 'weapon',
            atk : 10
        },{
            type : 'weapon',
            atk : 20
        },{
            type : 'weapon',
            atk : 30
        },{
            type : 'weapon',
            atk : 40
        },{
            type : 'armor',
            def : 10
        },{
            type : 'armor',
            def : 20
        },{
            type : 'armor',
            def : 30
        },{
            type : 'armor',
            def : 40
        },{
            type : 'shoes',
            agi : 10
        },{
            type : 'shoes',
            agi : 20
        },{
            type : 'shoes',
            agi : 30
        },{
            type : 'shoes',
            agi : 40
        },{
            type : 'pants',
            hp : 10
        },{
            type : 'pants',
            hp : 20
        },{
            type : 'pants',
            hp : 30
        }, {
            type : 'pants',
            hp : 40
        }
    ]
    

    let gameLoopThread;  //animation Thread ID

    let mainBox = {};
    let mainBar = {};
    let inven = {};
    let statBox = {};
    let statBar = {};
    let LVupBox = {};
    let invenBox = {};
    let pauseBox = {};

    window.addEventListener("load", init, false);

    const color = {
        gold : '#726447',
        black : '#050D0B',
        lightBlack : '#151D1B',
        darkGreen : '#102020',
        lightRed : '#EB5335',
        gray : '#8C8C8C',
        green : '#70AD47',
        yellow : '#FFB801',
        lightYellow : '#CDD121',
        red : '#BC252A'
    };

    function init(){
        //canvas = document.getElementById("canvas");
        canvasCtx = canvas.getContext("2d");

        bufferCtx = canvasBuffer.getContext("2d");

        playerUnit.x = canvas.width / 2 - 18;
        playerUnit.y = canvas.height / 2 - 18;
        playerUnit.agl = 0;

        playerUnit.atk = 1;
        playerUnit.def = 0;
        playerUnit.maxHp = 30;
        playerUnit.agi = 0;
        playerUnit.lv = 1;
        playerUnit.exp = 0;
        playerUnit.stat = 100;

        playerUnit.hp = 30;
        playerUnit.mp = 0;

        pointer.x = playerUnit.x;
        pointer.y = playerUnit.y;

        document.addEventListener("keydown", getKeyDown, false);
        document.addEventListener("keyup", getKeyUp, false);

        setImage();

        gameLoopThread = setInterval(gameLoop, threadSpeed);

        monsterRegenThread = setInterval(genMonster, monsterRegenSpeed);

        genMonster();

        for(let i=0; i<13; i++){
            inventory[i] = {};
            inventory[i].id = undefined;
            inventory[i].clicked = false;
        }
    }

    function gameLoop(){  
        calcKeyInput();
        displayAll();
        if(!isPause){
            moveMonster();
            damageMonster();
        }
    }

    function calcKeyInput(){
        
        //console.log(keyPressOn);
        if(!isPause){
            if(keyPressOn["38"] && playerUnit.y >= 0){
                playerUnit.y -= playerUnit.Y_speed;  //up
            }
            if(keyPressOn["40"] && playerUnit.y <= canvas.height -playerUnit.height){
                
                playerUnit.y += playerUnit.Y_speed;  //down
            }
            if(keyPressOn["37"] && playerUnit.x >= 0){
                playerUnit.x -= playerUnit.X_speed;  //left
            }
            if(keyPressOn["39"] && playerUnit.x <= canvas.width - playerUnit.width){
                playerUnit.x += playerUnit.X_speed;  //right
            }

            if(playerUnit.stat != 0){
                if(keyPressOn["16"]){
                    let keyArr = [82, 84, 70, 71];
                    for(let i=0; i<4; i++){
                        if(keyPressOn[`${keyArr[i]}`] && !isPush && oldPush == 0){
                            if(i == 0) playerUnit.atk++;
                            else if(i == 1) playerUnit.def++;
                            else if(i == 2) playerUnit.maxHp++;
                            else if(i == 3) playerUnit.agi++;
                            playerUnit.stat--;
                            isPush = !isPush;
                            oldPush = keyArr[i];
                        }
                        else if(!keyPressOn[`${keyArr[i]}`] && isPush && oldPush == keyArr[i]){
                            isPush = false;
                            oldPush = 0;
                        }
                    }
                }
            }
            else{
                oldPush = 0;
            }   
        }
        
        if(keyPressOn["27"] && !isPush && oldPush == 0){
            
            isPause = !isPause;
            isPush = !isPush;
            console.log(isPause);
        }
        else if(!keyPressOn["27"] && isPush && oldPush == 0){
            isPush = !isPush;
        }

        for(let i = 0; i<droppedItems.length; i++){
            //console.log(droppedItems);
            checkGetItem(playerUnit, droppedItems[i], i);
        }
           
        setUnitAngle(playerUnit, pointer.x, pointer.y);
        //if(agl != null) playerUnit.agl = agl;
    }

    function displayAll(){
        drawRoad();
        
        bufferCtx.beginPath();
        var startAngle = 0; 

        drawDroppedItems();

        for(unit of monsters){
            drawUnit(unit, ghost);
            drawMonsterHPBar(color.black, color.red, color.gold, unit);
        }

        setPlayerStatus(playerUnit, 'speed');
        drawUnit(playerUnit);

        drawMainUI();
        
        canvasCtx.drawImage(canvasBuffer, 0, 0);
    }

    function drawMainUI(){
        let list = [
            {
                name: 'ATK',
                value: playerUnit.atk,
                color: color.lightRed
            },
            {
                name: 'DEF',
                value: playerUnit.def,
                color: color.gray
            },
            {
                name: 'H P',
                value: playerUnit.maxHp,
                color: color.green
            },
            {
                name: 'AGI',
                value: playerUnit.agi,
                color: color.yellow
            },
            {
                name: 'L V',
                value: playerUnit.lv,
                color: color.lightYellow
            },
            {
                name: 'EXP',
                value: playerUnit.exp,
                color: color.lightYellow
            }
        ];

        drawMainBox({fill: color.darkGreen, line: color.gold});
        
        drawMainBar({fill: '#00B801', emptyFill: color.black, line: color.gold}, 0.7, playerUnit.hp / playerUnit.maxHp * 100);
        drawMainBar({fill: '#2183F3', emptyFill: color.black, line: color.gold}, 0.9, playerUnit.mp);

        for(let i=0; i<9; i++){
            drawInven({fill: color.lightBlack, line: color.gold}, i);    
        }

        drawStatBox({fill: color.darkGreen, line: color.gold});
        
        for(let i=0; i<6; i++){
            drawStat(list[i].name,  list[i].value, list[i].color , i);
        }

        if(playerUnit.stat != 0){
            drawLVup({fill: color.darkGreen, line: color.gold}, playerUnit.stat);
        }

        drawInvenBox({fill: color.darkGreen, line: color.gold});

        for(let i=0; i<4; i++){
            drawEquipment({fill: color.lightBlack, line: color.gold}, i);
        }

        for(let i=0; i<14; i++){
            drawInvenItem(i, inventory[i]);    
        } 
        if(isPause){
            drawPauseBox({fill: color.darkGreen, line: color.gold})
        }
    }

    
    
</script>
</html>